<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0">
    <title>Вход - LinguaGlow</title>
</head>
<body>
    <div id="vkid-login"></div>

    <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
    <script type="text/javascript">
        if ('VKIDSDK' in window) {
            const VKID = window.VKIDSDK;

            VKID.Config.init({
                app: 54246351,
                redirectUrl: 'https://fbe04798e5ad.ngrok-free.app/auth/vk/custom-login/', // оставляем пустым, чтобы не было GET редиректа
                responseMode: VKID.ConfigResponseMode.Callback,
                source: VKID.ConfigSource.LOWCODE,
                scope: 'email',
            });

            const oneTap = new VKID.OneTap();

            oneTap.render({
                container: document.getElementById('vkid-login'),
                showAlternativeLogin: true,
            })
            .on(VKID.WidgetEvents.ERROR, vkidOnError)
            .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, async function(payload) {
                try {
                    const result = await VKID.Auth.exchangeCode(payload.code, payload.device_id);

                    const response = await fetch('/auth/vk/custom-login/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(result)
                    });

                    const data = await response.json();
                    console.log('Logged in', data);

                    if (data.status === 'ok') {
                        window.location.href = '/dashboard/';
                    }
                } catch (err) {
                    console.error('VKID Auth error', err);
                }
            });


            function vkidOnError(error) {
                console.error('VKID error:', error);
            }
        }
    </script>
</body>
</html>
