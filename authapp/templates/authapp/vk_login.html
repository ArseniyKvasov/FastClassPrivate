<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>VK Login OneTap</title>
</head>
<body>

    <h1>Авторизация VK ID</h1>
    <div id="vkid-login"></div>

    <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>

    <script>
        const VKID = window.VKIDSDK;

        VKID.Config.init({
            app: 54246351,
            redirectUrl: 'https://158088a2ae1b.ngrok-free.app/auth/vk/custom-login/',
            responseMode: VKID.ConfigResponseMode.Callback,
            source: VKID.ConfigSource.LOWCODE,
            scope: 'email',
        });

        async function handleAuth(result) {
            const response = await fetch("", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(result)
            });

            const data = await response.json();
            if (data.status === "ok") {
                window.location.href = "/dashboard/";
            } else {
                console.error("AUTH ERR", data);
            }
        }

        // ✅ 1) Проверяем, есть ли данные редиректа
        const callbackData = VKID.Auth.getCallbackData();

        if (callbackData && callbackData.code && callbackData.device_id) {
            console.log("REDIRECT CALLBACK:", callbackData);

            // ✅ 2) Выполняем обмен токенов вручную
            VKID.Auth.exchangeCode(callbackData.code, callbackData.device_id)
                .then(handleAuth)
                .catch(err => console.error("EXCHANGE ERROR:", err));

        } else {
            console.log("NO REDIRECT DATA, render OneTap");

            // ✅ Стандартный OneTap
            const oneTap = new VKID.OneTap();
            oneTap.render({
                container: document.getElementById('vkid-login'),
                showAlternativeLogin: true
            })
            .on(VKID.WidgetEvents.ERROR, (e) => console.error("VKID ERR", e))
            .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, async (payload) => {
                console.log("LOGIN_SUCCESS", payload);
                const result = await VKID.Auth.exchangeCode(payload.code, payload.device_id);
                handleAuth(result);
            });
        }
    </script>

</body>
</html>
