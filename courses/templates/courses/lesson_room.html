{% extends 'pages/base.html' %}
{% load static %}

{% block content %}
    <style>
        #sidebar {
            position: sticky;
            top: 80px;
            height: calc(100vh - 120px);
        }

        #section-list .list-group-item {
            cursor: pointer;
            transition: background-color 0.15s ease;

            /* Скрываем скроллбар во всех браузерах */
            scrollbar-width: none;        /* Firefox */
            -ms-overflow-style: none;     /* IE и Edge */
        }

        #section-list::-webkit-scrollbar {
            display: none;                /* Chrome, Safari, Opera */
        }

        #section-list .list-group-item:hover {
            background-color: #f6f8fa;
        }

        .section-link {
            color: #0d6efd;
            font-weight: 500;
        }

        .section-link:hover {
            color: #0a58ca;
        }
        .dropdown-item:hover, .dropdown-item:focus {
            background-color: #f8f9fa !important;
        }

        .dropdown-item.active {
            background-color: #f8f9fa !important;
            color: #212529 !important;
            font-weight: 600;
        }
    </style>

    <!-- Инфо -->
    <script>
        let sectionId = `{{ section_id }}`;
        let isAdmin = `{{ is_admin }}`;
        let lessonId = `{{ lesson_id }}`;
        let isClassroom = `{{ room_type }}` === 'Classroom';
        let currentUserId = {{ current_user_id|default:"null" }};
        let virtualClassId = null;
        if (isClassroom) {
            virtualClassId = `{{ classroom_id }}`;
        }
    </script>

    <div id="info-block" data-virtual-classroom-id="{{ classroom_id }}"></div>

    <div class="row mt-4 d-flex justify-content-center">
        <div id="main-container" class="col-12 col-xl-9">
            <div id="task-list" class="bg-white p-3 rounded shadow-sm" style="min-height: 400px;"></div>

            <button id="add-task-btn" class="btn btn-outline-primary w-100 p-4 fs-5 fw-bold shadow-sm border-primary my-3">
                <i class="bi bi-plus-circle me-2"></i>
                Добавить задание
            </button>
        </div>

        <!-- Боковая панель -->
        <div id="sidebar" class="col-12 col-xl-3 mb-4 mb-xl-0 d-flex flex-column"
             style="position: sticky; top: 5rem; max-height: 80vh; max-height: 300px;">

            <!-- Видеозвонок -->
            {% if room_type == "Classroom" %}
                <div class="btn btn-primary fw-bold mb-2 d-none d-xl-block w-100">
                    Видеозвонок
                </div>
            {% endif %}

            <div class="card shadow-sm rounded p-2 d-flex flex-column justify-content-between"
                 style="max-height: 80vh; overflow-y: hidden;">

                <!-- Список разделов -->
                <ul id="section-list" class="list-group list-group-flush mb-2"
                    style="overflow-y: auto; max-height: calc(80vh - 60px);">
                    {% for section in sections %}
                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-2 my-1 rounded"
                            data-section-id="{{ section.id }}" data-section-type="{{ section.type|default:'default' }}">
                            <div class="d-flex align-items-center gap-2" style="flex:1; min-width:0;">
                                {% if is_admin and room_type != "Classroom" %}
                                    <span class="drag-handle me-2" aria-hidden="true" title="Перетащить">☰</span>
                                {% endif %}
                                <button type="button"
                                        class="btn btn-link section-link text-decoration-none text-truncate p-0 me-2"
                                        data-section-id="{{ section.id }}">
                                    {{ section.title }}
                                </button>
                            </div>
                            {% if is_admin and room_type != "Classroom" %}
                                <div class="section-action-buttons d-flex gap-2">
                                    <button type="button" class="btn btn-link p-0 edit-section-button" data-section-id="{{ section.id }}" title="Редактировать">
                                        <i class="bi bi-pencil-fill text-secondary"></i>
                                    </button>
                                    <button type="button" class="btn btn-link p-0 delete-btn" data-section-id="{{ section.id }}" title="Удалить">
                                        <i class="bi bi-trash3-fill text-secondary"></i>
                                    </button>
                                </div>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>

                <!-- Кнопка "Добавить раздел" -->
                {% if is_admin %}
                    <div id="section-create-wrapper">
                        <button id="add-section-btn"
                                class="btn btn-sm text-primary border-0 fw-bold w-100 text-start mb-2">
                            <i class="bi bi-plus-circle me-1"></i> Добавить раздел
                        </button>
                        <div id="section-create-container" class="w-80 mx-auto d-flex align-items-center gap-2"></div>
                    </div>
                {% endif %}
            </div>

        </div>
    </div>



    {% if is_admin %}
    <div class="d-flex position-fixed justify-content-end end-0 align-items-center p-2 m-2"
         style="z-index: 1039; width: auto; max-width: 100%; bottom: 0px; transform: translateX(5px);"
         id="panel">
        {% if room_type == 'Classroom' %}
        <div class="d-flex bg-white rounded shadow">
            <div class="m-2">
                <div class="dropdown d-inline-block ms-2 dropup">
                    <button class="btn btn-sm btn-primary dropdown-toggle rounded" type="button" id="studentDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Весь класс
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow text-truncate" aria-labelledby="studentDropdown" style="max-width: 250px;" id="studentDropdownMenu">
                        <li><a class="dropdown-item student-option active" href="#" data-student-id="all">Весь класс</a></li>
                    </ul>
                </div>

                <div class="dropdown d-inline-block ms-2 dropup">
                    <button class="btn btn-sm btn-secondary rounded" type="button" id="controlPanelDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="controlPanelDropdown">
                        <li>
                            <button type="button" class="dropdown-item text-primary fw-semibold" data-bs-toggle="modal" data-bs-target="#chooseLessonModal">
                                <i class="bi bi-book me-2"></i> Выбрать урок
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item text-danger fw-semibold" id="disableCopyingButton">
                                <i class="bi bi-ban me-2"></i>
                                <span class="text">Запретить копирование</span>
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item text-secondary fw-semibold" id="refreshPageButton">
                                <i class="bi bi-arrow-clockwise me-2"></i> Обновить страницу
                            </button>
                        </li>
                        <li>
                            <button class="d-block d-xl-none dropdown-item text-success fw-semibold join-mobile-btn">
                                <i class="bi bi-telephone me-2"></i> Присоединиться
                            </button>
                        </li>
                        <li>
                            <a href="/classroom/d79048bf-e290-4857-ae15-dc51aac7e696/send-homework-page/" class="dropdown-item text-primary fw-semibold">
                                <i class="bi bi-send me-2"></i> Отправить Д/з
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {% block admin-classroom %}
    {% endblock %}
    {% endif %}





    <div id="notification-container"
         class="position-fixed bottom-0 start-0 mb-3 ms-3 d-flex flex-column-reverse gap-2"
         style="z-index: 1155; max-height: 60vh; max-width: 70vw; overflow-y: auto;">
    </div>


    <!-- Компоненты редактирования -->
    {% if is_admin %}
    {% include 'courses/editor/task_selection_modal.html' %}
    {% include 'courses/editor/section_create_modal.html' %}
    <script src="{% static 'component_editors/test.js' %}"></script>
    <script src="{% static 'component_editors/truefalse.js' %}"></script>
    <script src="{% static 'component_editors/note.js' %}"></script>
    <script src="{% static 'component_editors/match.js' %}"></script>
    <script src="{% static 'component_editors/image.js' %}"></script>
    <script src="{% static 'component_editors/fillgaps.js' %}"></script>
    <script src="{% static 'component_editors/textinput.js' %}"></script>
    <script src="{% static 'component_editors/integration.js' %}"></script>
    {% endif %}


    <!-- JS-утилиты -->
    <script src="{% static 'utils/common_utils.js' %}"></script>
    {% if is_admin %}
    <script src="{% static 'utils/editor_utils.js' %}"></script>
    {% endif %}

    <!-- Отображение заданий -->
    <script src="{% static 'component_display/test.js' %}"></script>
    <script src="{% static 'component_display/truefalse.js' %}"></script>
    <script src="{% static 'component_display/note.js' %}"></script>
    <script src="{% static 'component_display/match.js' %}"></script>
    <script src="{% static 'component_display/image.js' %}"></script>
    <script src="{% static 'component_display/fillgaps.js' %}"></script>
    <script src="{% static 'component_display/textinput.js' %}"></script>
    <script src="{% static 'component_display/integration.js' %}"></script>
    <script src="{% static 'utils/tasks_mapping.js' %}"></script>
    {% if room_type == 'Classroom' %}
    <script src="{% static 'classroom/answer_handlers.js' %}"></script>
    <script src="{% static 'classroom/panel_utils.js' %}"></script>
    <script>
        const studentsList = {{ students_list|safe }};
        initStudentPanel(studentsList);
    </script>
    {% endif %}
{% endblock %}
