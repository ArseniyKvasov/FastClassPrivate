{% extends 'core/base.html' %}
{% load static %}

{% block content %}
    <style>
        #sidebar {
            position: sticky;
            top: 80px;
            height: calc(100vh - 120px);
        }

        #section-list .list-group-item {
            cursor: pointer;
            transition: background-color 0.15s ease;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #section-list::-webkit-scrollbar {
            display: none;
        }

        #section-list .list-group-item:hover {
            background-color: #f6f8fa;
        }

        .section-link {
            color: #0d6efd;
            font-weight: 500;
        }

        .section-link:hover {
            color: #0a58ca;
        }

        .dropdown-item:hover,
        .dropdown-item:focus {
            background-color: #f8f9fa !important;
        }

        .dropdown-item.active {
            background-color: #f8f9fa !important;
            color: #212529 !important;
            font-weight: 600;
        }

        .horizontal-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .student-card {
            min-width: 120px;
            max-width: 180px;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            text-align: center;
            font-size: 0.85rem;
            line-height: 1.2;
        }

        .student-card .name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-card .stats {
            display: flex;
            justify-content: space-between;
            font-variant-numeric: tabular-nums;
        }
    </style>

    <div id="info"
         data-is-teacher="{{ is_teacher|yesno:'true,false' }}"
         data-lesson-id="{{ lesson_id }}"
         data-viewed-user-id="{{ viewed_user_id }}"
         data-is-classroom="true"
         data-classroom-id="{{ classroom_id }}"
    >
    </div>
    {{ students_list|json_script:"students-data" }}

    <!-- Отображение заданий -->
    <script type="module">
        import { loadSectionTasks } from "{% static 'js/tasks/display/showTasks.js' %}";
    </script>

    <!-- Отображение списка разделов -->
    <script type="module">
        import { initRenderSections, selectSection } from "{% static 'js/tasks/display/renderSections.js' %}";

        document.addEventListener("DOMContentLoaded", () => {
            initRenderSections();
        });
    </script>

    {% if is_teacher %}
        <!-- Загрузка модальных окон для редактирования -->
        {% include 'core/tasks/task_selection_modal.html' %}
        {% include 'core/tasks/section_create_modal.html' %}

        <!-- Редактирование заданий -->
        <script type="module">
            import { initEditTasks } from "{% static 'js/tasks/editor/edit.js' %}";

            initEditTasks();
        </script>

        <!-- Загрузка панели управления учениками -->
        {% include 'core/tasks/teacher_panel.html' %}

        <script type="module">
            import { initStudentPanel } from "{% static 'classroom/answers/teacherPanel.js' %}";

            const studentsList = JSON.parse(
                document.getElementById("students-data").textContent
            );

            initStudentPanel(studentsList);
        </script>
    {% endif %}

    <!-- Ответы -->
    <script type="module">
        import { registerAnswerEvents } from "{% static 'classroom/answers/handleAnswer.js' %}";

        registerAnswerEvents();
    </script>

    <!-- Взаимодейтсвие Websocket -->
    <script type="module">
        import { initVirtualClassWebSocket } from "{% static 'classroom/answers/websocket/init.js' %}";
        import { initAnswerEvents } from "{% static 'classroom/answers/websocket/sendMessage.js' %}";

        initVirtualClassWebSocket();
        initAnswerEvents();
    </script>

    <div class="row mt-4 d-flex justify-content-center">
        <div id="main-container" class="col-12 col-xl-9">
            <div id="task-list" class="bg-white p-3 rounded shadow-sm" style="min-height: 400px;"></div>

            {% if is_teacher %}
            <button id="add-task-btn"
                    class="btn btn-outline-primary w-100 p-4 fs-5 fw-bold shadow-sm border-primary mt-3">
                <i class="bi bi-plus-circle me-2"></i>
                Добавить задание
            </button>
            {% endif %}
        </div>

        <div id="sidebar"
             class="col-12 col-xl-3 my-4 my-xl-0 d-flex flex-column"
             style="top: 5rem; max-height: 80vh;">

            <div class="btn btn-primary fw-bold mb-2 d-none d-xl-block w-100">
                Видеозвонок
            </div>

            <div class="card shadow-sm rounded p-2 d-flex flex-column"
                 style="max-height: 80vh; overflow-y: hidden;">

                <ul id="section-list"
                    class="list-group list-group-flush"
                    style="overflow-y: auto; max-height: calc(80vh - 60px);">
                </ul>
            </div>
        </div>
    </div>

    <div id="notification-container"
         class="position-fixed bottom-0 start-0 mb-3 ms-3 d-flex flex-column-reverse gap-2"
         style="z-index: 1155; max-height: 60vh; max-width: 70vw; overflow-y: auto;">
    </div>


{% endblock %}
